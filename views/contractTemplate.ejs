<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Booking Contract</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      padding: 40px;
      font-size: 14px;
      color: #111;
    }
    h1,h2,h3 { margin: 0.6rem 0; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: .02em; }
    .subtitle { font-size: 14px; color:#555; }
    .contract-section p {
      margin-bottom: 0.75rem;
      line-height: 1.6;
    }
    .contract-section strong {
      display: block;
      margin-top: 1rem;
      font-size: 1.1rem;
    }
    .contract-section table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    .contract-section th, .contract-section td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    .contract-section ul {
      padding-left: 1.25rem;
      margin-bottom: 1rem;
    }
    .header-logo {
      width: 200px;
      margin-bottom: 20px;
    }
    .signature {
      margin-top: 40px;
    }
    .signature img {
      width: 200px;
      height: auto;
    }
    .contract-section { line-height:1.5; }
    ul { margin:0.5rem 1rem; }
    table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align:left; }

    .subtitle strong{
  display: inline;
  margin-top: 0;
  font-size: inherit;
}
  </style>
</head>
<body>
  <img src="https://res.cloudinary.com/dvcgr3fyd/image/upload/v1762950219/4_tt3cay.png" alt="The Supreme Collective Logo" class="header-logo" />
  <div class="title">THE <span style="color:#ff6667">CONTRACT</span></div>
<%
  const t = totals || {};
  const fullAmount = Number(t.fullAmount ?? total ?? 0);
  const chargedAmount = Number(t.chargedAmount ?? deposit ?? 0);

  const bookingTotalDisplay = fullAmount;               // “Booking total” should be the full contract value
  const depositDisplay = `£${chargedAmount.toFixed(2)}`; // Always show what was paid
  const outstanding = Math.max(0, fullAmount - chargedAmount);
%>
    <div class="contract-section" aria-label="Booking contract terms">
      <p class="subtitle">
        Booking ID: <strong><%= bookingId %></strong><br/>
        Contract Issued On: <strong><%= new Date().toLocaleDateString("en-GB") %></strong><br/>
Client: <%= [userAddress?.firstName, userAddress?.lastName].filter(Boolean).join(" ") || "—" %><br/>
        Client Address: <%= userAddress
  ? [
      userAddress.street,
      userAddress.city,
      userAddress.county,
      userAddress.postcode,
      userAddress.country,
    ]
      .map(v => String(v || "").trim())
      .filter(Boolean)
      .join(", ")
  : "—" %><br/>
Venue: <%= (typeof venue !== "undefined" && venue) ? venue : (venueAddress || "TBC") %><br/>
<% if (eventDate) { %>
  Event Date: <%= new Date(eventDate).toLocaleDateString("en-GB") %><br/>
<% } %>
<% if (eventType) { %>
  Event Type: <%= eventType %><br/>
<% } %>
        Act(/s): <%= (actsSummary || [])
  .map(a => a?.tscName || a?.actName || a?.name || "—")
  .join(", ")
%>
 </p>

      <hr style="margin:24px 0"/>

<h2>Booking Details</h2>

<% if (!actsSummary || actsSummary.length === 0) { %>
  <div>—</div>
<% } else { %>
  <% actsSummary.forEach(function(it){ %>
    <div style="display:flex; gap:12px; align-items:flex-start; margin:10px 0;">
      <% if (it.image && it.image.url) { %>
        <img src="<%= it.image.url %>" alt="<%= it.tscName || it.actName || it.name || '' %>" style="width:160; height:200; object-fit:cover; border-radius:6px;"
             onerror="this.style.display='none'"/>
      <% } %>
      <div style="flex:1; min-width:0;">
        <div>
<strong><%= it.tscName || it.actName || it.name || "—" %></strong>
<%
  // ---- Normalised size label (avoid "6-Piece-Piece") ----
  const rawSize = it.lineupLabel || it.actSize || (it.bandMembers?.length || 0);
  let pieceLabel = '';
  if (rawSize != null && rawSize !== '') {
    let s = String(rawSize).trim();
    // If label already contains "Piece", normalise to single "-Piece"
    if (/piece/i.test(s)) {
      s = s.replace(/\s+/g, ' ').replace(/\s*-/g, '-').replace(/-?piece$/i, '');
      pieceLabel = `${s}-Piece`;
    } else {
      pieceLabel = `${s}-Piece`;
    }
    // Final de-dupe safeguard
    pieceLabel = pieceLabel.replace(/-Piece-?Piece$/i, '-Piece');
  }

  // ---- Count essential instruments (preserve specific labels) ----
  const essential = Array.isArray(it.bandMembers)
    ? it.bandMembers.filter(m => m && m.isEssential)
    : [];

 const normaliseInst = (val) => {
  if (!val) return "";
  let t = String(val).trim();

  // ✅ Preserve vocalist-guitarist style roles
  const hasVocal = /vocal|singer/i.test(t);
  const hasGuitar = /guitar/i.test(t);

  if (hasVocal && hasGuitar) {
    // keep acoustic/electric nuance if present
    if (/acoustic/i.test(t)) return "Vocalist-Acoustic Guitarist";
    if (/electric/i.test(t)) return "Vocalist-Electric Guitarist";
    return "Vocalist-Guitarist";
  }

  // Standardise common instruments
  if (/bass\s*guitar/i.test(t)) return "Bass";
  if (/\bkeys?|keyboard/i.test(t)) return "Keys";
  if (/guitars?/i.test(t) && !/bass/i.test(t)) return "Guitar";
  if (/drums?/i.test(t)) return "Drums";

  // Normalise generic vocals (only when not already "lead ...")
  if (/(^|\s)(singer|vocals?)($|\s)/i.test(t) && !/lead/i.test(t)) {
    return "Vocal";
  }

  // Title case fallback
  t = t.replace(/\b\w/g, (c) => c.toUpperCase());
  return t;
};

  const counts = {};
  essential.forEach(m => {
    const lbl = normaliseInst(m.instrument || m.role || '');
    if (!lbl) return;
    counts[lbl] = (counts[lbl] || 0) + 1;
  });

  // ---- Order: vocals first, others alpha, drums last ----
  const labels = Object.keys(counts);
  const vocals = labels.filter(l => /vocal/i.test(l));
  const drums = labels.filter(l => /drums?/i.test(l));
  const others = labels.filter(l => !/vocal/i.test(l) && !/drums?/i.test(l)).sort((a,b) => a.localeCompare(b));
  const ordered = [...vocals, ...others, ...drums];

  const formatWithCounts = (arr) => {
    const parts = arr.map(l => counts[l] > 1 ? `${l} ×${counts[l]}` : l);
    if (parts.length <= 2) return parts.join(' & ');
    return parts.slice(0, -1).join(', ') + ' & ' + parts[parts.length - 1];
  };
  const instrumentList = formatWithCounts(ordered);

  // ---- Essential additional roles → bracketed note ----
  const rolesRaw = (Array.isArray(it.bandMembers) ? it.bandMembers : [])
    .flatMap(m => (m.additionalRoles || []).filter(r => r.isEssential).map(r => r.role))
    .filter(Boolean);
  const uniqueRoles = Array.from(new Set(rolesRaw.map(r => String(r).trim())));
  const formatRoles = (arr) => {
    if (!arr.length) return '';
    const pretty = arr.map(r => r.replace(/\b\w/g, c => c.toUpperCase()));
    if (pretty.length <= 2) return pretty.join(' & ');
    return pretty.slice(0, -1).join(', ') + ' & ' + pretty[pretty.length - 1];
  };
  const rolesList = uniqueRoles.length ? ` (including ${formatRoles(uniqueRoles)} services)` : '';

const description = `${pieceLabel ? pieceLabel + ': ' : ''}${instrumentList}${rolesList}`;%>
<div style="margin-top:4px; font-size:14px; color:#111;">
  <%= description %>
</div>

        <% 
          // Determine if lineup has any vocalists
          const hasVocalists =
            Array.isArray(it.bandMembers) &&
            it.bandMembers.some(m => (m.instrument || "").toLowerCase().includes("vocal"));

          // Determine if a chosen vocalist exists (from PlaceBooking selectedVocalist snapshot)
          const sv = it.selectedVocalist;
        %>

        <% if (sv && hasVocalists) { %>
          <div style="margin-top:4px; font-size:13px; color:#444;">
            Vocalist selected: <%= sv.firstName %> <%= sv.lastNameInitial %>.
          </div>
        <% } %>
        </div>

        <% if (Number(it.quantity||0) > 1) { %>
          <div>Quantity: <%= Number(it.quantity) %></div>
        <% } %>

        <% if (it.performance) { %>
          <div style="margin-top:4px;">
            <% if (it.performance.arrivalTime) { %>
              <div>Arrival: <%= it.performance.arrivalTime %></div>
            <% } %>
            <% if (it.performance.setupAndSoundcheckedBy) { %>
              <div>Soundcheck by: <%= it.performance.setupAndSoundcheckedBy %></div>
            <% } %>
            <% if (it.performance.startTime) { %>
              <div>Start: <%= it.performance.startTime %></div>
            <% } %>
            <% if (it.performance.finishTime) { %>
              <div>
                Finish: <%= it.performance.finishTime %>
                <% if (it.performance.finishDayOffset) { %>
                  (+<%= it.performance.finishDayOffset %>d)
                <% } %>
              </div>
            <% } %>
          </div>
        <% } %>

        <% if (Array.isArray(it.afternoonSets) && it.afternoonSets.length) { %>
          <div style="margin-top:4px;">
            <div style="font-size:12px; color:#666;">Afternoon Sets:</div>
            <ul style="margin:6px 0 0 18px;">
              <% it.afternoonSets.forEach(function(set){ %>
                <li>
                  <%= set.name || set.label || "Set" %>
                  <% if (Number(set.price)) { %>
                    (£<%= Number(set.price).toFixed(2) %>)
                  <% } %>
                </li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <% if (Array.isArray(it.selectedExtras) && it.selectedExtras.length) { %>
          <div style="margin-top:4px;">
            <div style="font-size:12px; color:#666;">Extras:</div>
            <ul style="margin:6px 0 0 18px;">
              <% it.selectedExtras.forEach(function(ex){ %>
                <li>
                  <%= ex.name || ex.key %>
                  <% if (ex.quantity && Number(ex.quantity) > 1) { %> × <%= Number(ex.quantity) %><% } %>
                </li>
              <% }) %>
            </ul>
          </div>
        <% } %>
      </div>
    </div>
  <% }) %>

  <hr style="margin:12px 0"/>

  <div style="font-size:14px;">
  <div style="display:flex; justify-content:space-between;">
  <span>Booking total</span>
  <span>£<%= bookingTotalDisplay.toFixed(2) %></span>
</div>
<div style="display:flex; justify-content:space-between;">
  <span>Deposit paid</span>
  <span><%= depositDisplay %></span>
</div>
<div style="display:flex; justify-content:space-between; font-weight:700; margin-top:8px;">
  <span>Outstanding Balance</span>
  <span>£<%= outstanding.toFixed(2) %></span>
</div>
  </div>
<% } %>

      <p><strong>Key Points</strong></p>
      <ul>
        <li>This Contract is subject to The Supreme Collective's Terms and Conditions.</li>
        <li>The Client must complete the Event Sheet four weeks prior to the event to ensure the finer details of the performance can be processed in a timely fashion.</li>
        <li>Point of contact numbers should be provided on the Event Sheet.</li>
        <li>The Client must provide the Artist with a reasonable free supply of soft drinks, hot meal or hot buffet (for bookings when artist is on site for 3 hours or more), free parking for all vehicles, a secure changing area, and a safe, level, dry, covered performance area, unless otherwise noted.</li>
      </ul>

      <p><strong>Client Authorisation</strong></p>
      <p>
        By signing below, you confirm that you are the authorised signatory for contract <%= bookingId || 'TBC' %>
        (<%= (actsSummary || [])
  .map(a => a?.tscName || a?.actName || a?.name || "—")
  .join(", ")
%>, <%= new Date().toLocaleDateString('en-GB') %> and agree to be bound by The Supreme Collective’s Terms and Conditions of booking.
      </p>

      <p><strong>Agent Authorisation</strong></p>
      <p>
        Company Name: The Supreme Collective<br/>
        Artist Name(/s): <%= (actsSummary||[]).map(a => a?.tscName || a?.actName || a?.name || "—").join(", ") %>
      </p>

      <p><strong>The Supreme Collective - Terms and Conditions of Booking</strong></p>
      <p>If you do not understand any part of these Terms and Conditions, please check in with The Supreme Collective or seek legal advice before agreeing to them and confirming a booking.</p>

      <p><strong>Definition</strong></p>
      <p>The following definitions refer to the 'Contract' (The Supreme Collective Booking Contract) and these 'Terms and Conditions'. The Supreme Collective, Company No. 16883956, is the 'Agent', the proposed entertainment booker is the 'Client' and the proposed entertainment act is the 'Artist'.</p>

      <p><strong>1 | Introduction</strong></p>
      <p>This booking contract is provided by the Agent and is made between the Client and Agent on behalf of the Artist. In issuing this Contract, the Agent is acting as an employment agency for the Artist, and is responsible for ensuring all band members are allocated, and fully briefed in a timely manner in the run-up to the event, and the Artist is responsible for all preparation for the event, and performance on the day. Artist, Client, and Agent responsibilities are detailed within this contract. Any breach of contract can fall upon the Artist, or Client depending upon the item being breached.</p>

      <p><strong>2 | Booking</strong></p>
      <ul>
        <li>All bookings are confirmed immediately upon signing of this contract and with complete payment of the deposit. The booking is then confirmed.</li>
        <li>A copy of the contract will be shared with the Client. The Agent will file completed contracts and will store until 4 years after the contract completion date.</li>
        <li>The Contract may be modified/changed upon agreement from both parties in advance of the event date.</li>
        <li>Changes must be notified to the Agent who will re-issue the contract if necessary.</li>
        <li>The agreed total cost and Deposit amount may change with any alterations agreed by both the Client and Artist.</li>
        <li>The Agent will act as negotiator until the date of the event and completion of the contract.</li>
      </ul>

      <p><strong>3 | Payment of Booking Fees</strong></p>
      <ul>
        <li>The Deposit payment is due upon booking.</li>
        <li>The Balance (remaining fee owed) is due one week before the event day and must also be paid to the Agent.</li>
      </ul>

      <p><strong>4 | Late/Failure Payment of Balance</strong></p>
      <ul>
        <li>The Client must pay the Balance within the specified time.</li>
        <li>If the Client fails to do so, the Agent has the right to terminate the Contract without penalty. The Client would still be subject to the cancellation fee specified in Clause 6.1.1.</li>
        <li>The Agent has the right to claim interest of 20% on the balance of any late payments.</li>
        <li>Late payments will incur a £50 administration fee, payable by the Client to the Agent within 14 days.</li>
        <li>If full payment is not made within 14 days the debt may be passed to a Debt Recovery Firm by the Artist, possibly incurring additional costs.</li>
      </ul>

      <p><strong>5 | Cancellation</strong></p>
      <ul>
        <li>Termination of the Contract is only allowed in cases of 'Force Majeure' or if all parties mutually agree.</li>
        <li>In the event of mutual cancellation, the Deposit will not be refunded.</li>
      </ul>

      <p><strong>6 | Client Cancellation</strong></p>
      <ul>
        <li>If the Client cancels for any reason other than Force Majeure, cancellation fees apply.</li>
      </ul>

      <table>
        <thead><tr><th>Cancellation Timescale</th><th>Cancellation Fee</th></tr></thead>
        <tbody>
          <tr><td>More than 365 days before event</td><td>Nil</td></tr>
          <tr><td>Less than 24 hours after confirmation (8+ days before event)</td><td>Nil</td></tr>
          <tr><td>Less than 24 hours after confirmation within 7 days of event</td><td>Full Fee</td></tr>
          <tr><td>More than 90 days before event</td><td>60% of Full Fee</td></tr>
          <tr><td>Between 61-90 days before event</td><td>80% of Full Fee</td></tr>
          <tr><td>60 days or less before event</td><td>Full Fee</td></tr>
        </tbody>
      </table>

      <p><strong>7 | Artist Cancellation</strong></p>
      <ul>
        <li>The Agent cannot cancel on behalf of the Artist unless for Force Majeure.</li>
        <li>If Force Majeure applies, the Agent must present a replacement if possible, and refund 50% of the Deposit if not possible.</li>
        <li>If the Artist cancels improperly, the Client may seek legal recourse against the Artist.</li>
        <li>If a replacement Artist is secured and accepted, the Deposit is not refunded but transferred to the new act.</li>
      </ul>

      <p><strong>8 | Complaints</strong></p>
      <ul>
        <li>Complaints must be made in writing within 30 days of the incident.</li>
        <li>Payment obligations remain despite complaints.</li>
        <li>Any unnotified changes agreed between Client and Artist are to be dealt with directly between them.</li>
      </ul>

      <p><strong>9 | Responsibilities of the Client</strong></p>
      <ul>
        <li>Ensuring the venue provides safe, dry, and licensed conditions.</li>
        <li>Provide refreshments and hot meals for the Artist if required, as well as the appropriate number of chairs for the Artist.</li>
        <li>Free parking, which must be available, or parking expenses reimbursed.</li>
        <li>Changing area, which must be secure and adequate.</li>
        <li>Electrical sockets, as per the Artist's requirements.</li>
        <li>Ensure the Artist's equipment is safe from spillages and from guests.</li>
        <li>Ensure the Artist's is able to perform in a safe environment with no agression or violence towards them.</li>
      </ul>

      <p><strong>10 | Responsibilities of the Agent</strong></p>
      <ul>
        <li>Provide a service for Clients to find an Artist that is not double-booked through the company.</li>
        <li>Ensure Artist quality, professionalism, and safety compliance.</li>
        <li>Provide the Event Sheet and reminders to ensure both parties have all of the information they need so that the artist can carry out a successful performance.</li>
      </ul>

      <p><strong>11 | Expenses</strong></p>
      <p>Client is only liable for additional expenses if agreed in advance.</p>

      <p><strong>12 | Artist Equipment</strong></p>
      <p>Artist equipment must not be used by guests. Client is liable for any damage caused.</p>

      <p><strong>13 | Changes to Performance Schedule</strong></p>
      <ul>
        <li>Changes can be made on the Event Sheet up to one month before the performance date.</li>
        <li>Overruns by the Client do not extend Artist time unless agreed and paid for additionally.</li>
      </ul>

      <p><strong>14 | Deputies</strong></p>
      <p>The Agent may substitute musicians of similar ability without notice.</p>

      <p><strong>15 | Force Majeure</strong></p>
      <ul>
        <li>Force Majeure includes natural disasters, illness, war, terrorism, etc.</li>
        <li>Evidence must be provided to justify Force Majeure claims.</li>
      </ul>

      <p><strong>16 | Terms Acceptance</strong></p>
      <p>By signing the contract, you agree to all Terms and Conditions listed above.</p>
    </div>
  </body>
<footer style="margin-top: 60px; font-size: 12px; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
  <p>The Supreme Collective Ltd</p>
  <p>Tel: +44 7594 223200 | Email: hello@thesupremecollective.co.uk</p>
  <p>Address: Cramond, Reeves Lane, Roydon, CM19 5LE</p>
  <p>Company Number: 16883956</p>
</footer>